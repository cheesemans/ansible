- name: Install starship along with Nerdfont
  tags: [personal, work]
  block:
    - name: Install snap packages
      ansible.builtin.snap:
        name:
          - starship
      become: true

    - name: Copy starship config file
      ansible.builtin.copy:
        src: starship.toml
        dest: "{{ user_home }}/.config/starship.toml"
        mode: 0664

    - name: Create folder for FiraCode font if it does not exist
      ansible.builtin.file:
        path: /usr/local/share/fonts/FiraCode
        state: directory
        mode: 0755
      become: true

    - name: Check if FiraCode is already installed
      ansible.builtin.find:
        paths: /usr/local/share/fonts/FiraCode
      register: FontInstalled

    - name: Download and unpack FiraCode font
      ansible.builtin.unarchive:
        src: https://github.com/ryanoasis/nerd-fonts/releases/download/v2.2.2/FiraCode.zip
        dest: /usr/local/share/fonts/FiraCode
        remote_src: true
      become: true
      when: not FontInstalled.matched > 0

    - name: Rebuild font information cache files
      ansible.builtin.command: fc-cache -fv
      when: not FontInstalled.matched > 0

- name: Add init script to bashrc
  tags: work
  ansible.builtin.blockinfile:
    path: "{{ user_home }}/.bashrc"
    block: |
      # HSTR configuration - add this to ~/.bashrc
      alias hh=hstr                    # hh to be alias for hstr
      export HSTR_CONFIG=hicolor       # get more colors
      shopt -s histappend              # append new history items to .bash_history
      export HISTCONTROL=ignorespace   # leading space hides commands from history
      export HISTFILESIZE=10000        # increase history file size (default is 500)
      export HISTSIZE=${HISTFILESIZE}  # increase history size (default is 500)
      # ensure synchronization between bash memory and history file
      export PROMPT_COMMAND="history -a; history -n; ${PROMPT_COMMAND}"
      # if this is interactive shell, then bind hstr to Ctrl-r (for Vi mode check doc)
      if [[ $- =~ .*i.* ]]; then bind '"\C-r": "\C-a hstr -- \C-j"'; fi
      # if this is interactive shell, then bind 'kill last command' to Ctrl-x k
      if [[ $- =~ .*i.* ]]; then bind '"\C-xk": "\C-a hstr -k \C-j"'; fi

      # Load starship
      eval "$(starship init bash)"
